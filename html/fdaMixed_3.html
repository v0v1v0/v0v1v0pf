<div class="container">

<table style="width: 100%;"><tr>
<td>fdaLm</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Linear mixed-effects model for functional data</h2>

<h3>Description</h3>

<p>Fits variance and smoothing parameters, and possibly also
Box-Cox transformation, by maximum restricted likelihood. Estimate
fixed parameters, predict random effects, and predict serial
correlated effect at point of maximum restricted likelihood. Linear
models for fixed and random effects may be global or marginal over
sample times.</p>


<h3>Usage</h3>

<pre><code class="language-R">fdaLm(formula, data, design, boxcox = NULL, G = 1, lambda = 1, nlSearch
= TRUE, K.order = 1, D.order = NULL, Fleft = "tied", Fright = "tied",
left = NULL, right = NULL)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>

<p>A multiple formula of the type <code>Y|id ~ fixed|random</code>. Here
<code>Y</code> is the response variable, <code>id</code> is a factor 
separating the samples, <code>fixed</code> is a linear model for the fixed
effect, and <code>random</code> is a linear model for the random
effect.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>

<p>An optional data frame containing the variables. See details below.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>design</code></td>
<td>

<p>An optional data frame containing the design variables in the
specification of the fixed and the random effects. See details below.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>boxcox</code></td>
<td>

<p>The power parameter in the scale invariant Box-Cox transformation.
If <code>NULL</code> (default), then no transformation is performed. If a
numeric value is provided, then a scale invariant Box-Cox
transformation of the response variable is performed. The numeric
value is either used as it is (<code>nlSearch=FALSE</code>) or as the
starting point for a non-linear optimization (<code>nlSearch=TRUE</code>.)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>G</code></td>
<td>

<p>Variance of the random effects. Present implementation only allows
for independent random effects, i.e. <code>G</code> is scalar. Used
depending on <code>nlSearch</code> as described above.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lambda</code></td>
<td>

<p>Start value for the <code>lambda</code> parameter describing the
L-operator. Presently the following forms are implemented: If
<code>K.order</code> is odd, then <code>lambda</code> may have length=1
corresponding to <code>L=-lambda[1]*D^(2*K.order)</code>, or length=2
corresponding to <code>L=-lambda[1]*D^(2*K.order)+lambda[2]</code>. If
<code>K.order</code> is even, then <code>lambda</code> may have length=1
corresponding to <code>L=-lambda[1]*D^(2*K.order)</code>, length=2
corresponding to
<code>L=-lambda[1]*D^(2*K.order)+lambda[2]*D^K.order</code>, or length=3
corresponding to
<code>L=-lambda[1]*D^(2*K.order)+lambda[2]*D^K.order+lambda[3]</code>.
Used depending on <code>nlSearch</code> as described above.
All coefficients must be non-negative, and the leading coefficient
<code>lambda[1]</code> must be strictly positive. Coefficients equal to
zero are kept fixed at zero in the non-linear optimization.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nlSearch</code></td>
<td>

<p>If <code>TRUE</code> (default), then a non-linear optimization of the
parameters <code>boxcox</code>, <code>G</code>, <code>lambda</code> is performed
(present implementation uses <code>nlminb</code>). If <code>FALSE</code>,
then the initial values of the non-linear parameters are used.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>K.order</code></td>
<td>

<p>The order of the K-operator.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>D.order</code></td>
<td>

<p>The requested order of derivatives of the prediction of the serial
correlated effect <code>xBLUP</code>. If <code>NULL</code> (default), then
<code>D.order</code> is set to the maximal recommended order
<code>K.order</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Fleft</code></td>
<td>

<p>Specification of the <code>K.order</code> boundary conditions at the left
limit of the sampling interval. Value <code>"tied"</code> (default) gives
bridge-type conditions. Value <code>"open"</code> shifts up the
bridge-type conditions one differential order, hence removing the
restriction on the level (corresponding to the open end of a
Brownian motion). Otherwise arbitrary linear boundary conditions may
be specified as a matrix with dimension
(<code>K.order</code>,2*<code>K.order</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Fright</code></td>
<td>

<p>Similarly for the <code>K.order</code> boundary conditions at the right
limit of the sampling interval.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>left</code></td>
<td>

<p>Left limit of the sampling interval. If <code>NULL</code> (default), then
<code>left</code> is set to 0.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>right</code></td>
<td>

<p>Right limit of the sampling interval. If <code>NULL</code> (default), then
<code>right</code> is set to the number of sampling points. Thus, the
default values of <code>left</code> and <code>right</code> give sampling distance
equal to 1.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The response variable <code>Y</code> is taken from the data frame
<code>data</code> (subsidiary the parent environment). If there is more
than one sample, then the responses must be stacked sample-wise on top
of each other. The sample identifier <code>id</code> is sought for in both
data frames <code>data</code> and <code>design</code> (subsidiary the parent
environment). The primarily function of the identifier is to decide
the number of samples. But if <code>id</code> is present in both data
frames, and if there is more that one sample, then this variable is
also used to match the reponse vector to the design variables
(i.e. these need not appear in the same order).
</p>
<p>The design variables <code>fixed</code> and <code>random</code> for the fixed and
the random effects are taken from the data frame <code>design</code>
(subsidiary the parent environment), subsidiary from the data frame
<code>data</code> (subsidiary the parent environment).
</p>
<p>If the number of observations in the design variables equal the total
number of response observations, then a global ANOVA is performed. If the
number of observations in the design variables equal the number of
sample points, then a marginal ANOVA is performed.
</p>


<h3>Value</h3>

<p>A list with components
</p>
<table>
<tr style="vertical-align: top;">
<td><code>logLik</code></td>
<td>
<p>Minus twice the log restricted likelihood taken at the
estimates.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ANOVA</code></td>
<td>
<p>Specifies whether fixed and random effects were estimated
globally (<code>global</code>) or marginally (<code>marginal</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nlSearch</code></td>
<td>
<p>Specifies whether non-linear optimization was
performed (<code>TRUE</code> / <code>FALSE</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>counts</code></td>
<td>
<p>Number of computations of the negative log likelihood.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>boxcoxHat</code></td>
<td>
<p>Maximum restricted likelihood estimate for the power
parameter in the scale invariant Box-Cox transformation. Equal to
<code>not done</code> if the Box-Cox transformation is not used.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Ghat</code></td>
<td>
<p>Maximum restricted likelihood estimate for the variance
matrix of the random effects.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lambdaHat</code></td>
<td>
<p>Maximum restricted likelihood estimate for the lambda
parameter describing the L-operator.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sigma2hat</code></td>
<td>
<p>Maximum restricted likelihood estimate for the noise
variance.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>betaHat</code></td>
<td>
<p>For global ANOVA a vector with estimate for the fixed
effect. For marginal ANOVA a matrix with estimate for the fixed
effects.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>uBLUP</code></td>
<td>
<p>For global ANOVA a vector with prediction of the random
effect. For marginal ANOVA a matrix with predictions of the random
effects.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xBLUP</code></td>
<td>
<p>Array with predictions of serial correlated effects. The
dimension is (sample length,sample numbers,1+<code>D.order</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>condRes</code></td>
<td>
<p>Matrix of conditional residuals. The dimension is
(sample length,sample numbers).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>betaVar</code></td>
<td>
<p>Variance matrix of fixed effect estimate.</p>
</td>
</tr>
</table>
<h3>Note</h3>

<p>If the real value of the left most eigenvalues are non-positive, and
if the real value of the right most eigenvalues are non-negative,
then the underlying algorithm is numerical stable. This will always be
the situation for the present restriction of the L-operator. 
</p>
<p>If <code>lambda</code> has length=1, then it may also be interpreted as the
smoothing parameter in the penalized likelihood framework.
</p>
<p>If <code>D.order</code> is chosen larger than <code>K.order</code>, this number of
derivaties are also computed during the non-linear optimization. This
might slow down the computation speed a little bit.
</p>


<h3>Author(s)</h3>

<p>Bo Markussen &lt;bomar@math.ku.dk&gt;</p>


<h3>See Also</h3>

<p>See also <code>findRoots</code> and <code>dataTrans</code>.</p>


<h3>Examples</h3>

<pre><code class="language-R"># ---------------------
# Using a fixed effect
# ---------------------
x &lt;- seq(0,2*pi,length.out=200)
y.true &lt;- sin(x)+x
y.obs &lt;- y.true + rnorm(200)
est0 &lt;- fdaLm(y.obs~0,Fright="open",right=2*pi)
est1 &lt;- fdaLm(y.obs~0+x,Fright="open",right=2*pi)
plot(x,y.obs,main="Estimating the sum of a line and a curve")
lines(x,y.true,lty=2)
lines(x,est0$xBLUP[,1,1],col=2)
lines(x,est1$betaHat*x+est1$xBLUP[,1,1],col=3)
legend("topleft",c("True curve","Smooth","Line + smooth"),col=1:3,lty=c(2,1,1))

# --------------------------
# Including a random effect
# --------------------------
# Build data frame
test.frame &lt;- data.frame(y=rnorm(50),sample=factor(rep(1:5,each=10)),
                         x=rep(0:9,times=5),
                         f=factor(rnorm(50) &lt; 0,labels=c("a","b")),
                         j=factor(rnorm(50) &lt; 0,labels=c("A","B")))
test.frame$y &lt;- test.frame$y + 2 +
    3*(test.frame$f=="a")*test.frame$x + 5*(test.frame$f=="b")*test.frame$x +
(-10)*(test.frame$j=="A") + 10*(test.frame$j=="B")
# This is the model 'y|sample ~ f:x|j' with intercept=2, slopes (3,5),
# and random effects (-10,10)
est &lt;- fdaLm(y|sample ~ f:x|0+j,data=test.frame)
print(est)
</code></pre>


</div>