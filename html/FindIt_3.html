<div class="container">

<table style="width: 100%;"><tr>
<td>CausalANOVA</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Estimating the AMEs and AMIEs with the CausalANOVA.</h2>

<h3>Description</h3>

<p><code>CausalANOVA</code> estimates coefficients of the specified ANOVA with
regularization. By taking differences in coefficients, the function recovers
the AMEs and AMIEs.
</p>


<h3>Usage</h3>

<pre><code class="language-R">CausalANOVA(
  formula,
  int2.formula = NULL,
  int3.formula = NULL,
  data,
  nway = 1,
  pair.id = NULL,
  diff = FALSE,
  screen = FALSE,
  screen.type = "fixed",
  screen.num.int = 3,
  collapse = FALSE,
  collapse.type = "fixed",
  collapse.cost = 0.3,
  family = "binomial",
  cluster = NULL,
  maxIter = 50,
  eps = 1e-05,
  fac.level = NULL,
  ord.fac = NULL,
  select.prob = FALSE,
  boot = 100,
  seed = 1234,
  verbose = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>
<p>A formula that specifies outcome and treatment variables.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>int2.formula</code></td>
<td>
<p>(optional). A formula that specifies two-way
interactions.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>int3.formula</code></td>
<td>
<p>(optional). A formula that specifies three-way
interactions.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>An optional data frame, list or environment (or object coercible
by 'as.data.frame' to a data frame) containing the variables in the model.
If not found in 'data', the variables are taken from 'environment(formula)',
typically the environment from which 'CausalANOVA' is called.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nway</code></td>
<td>
<p>With <code>nway=1</code>, the function estimates the Average Marginal
Effects (AMEs) only. With <code>nway=2</code>, the function estimates the AMEs and
the two-way Average Marginal Interaction Effects (AMIEs). With
<code>nway=3</code>, the function estimates the AMEs, the two-way and three-way
AMIEs. Default is 1.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pair.id</code></td>
<td>
<p>(optional).Unique identifiers for each pair of comparison.
This option is used when <code>diff=TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>diff</code></td>
<td>
<p>A logical indicating whether the outcome is the choice between a
pair.  If <code>diff=TRUE</code>, <code>pair.id</code> should specify a pair of
comparison. Default is <code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>screen</code></td>
<td>
<p>A logical indicating whether select significant factor
interactions with <code>glinternet</code>.  When users specify interactions using
<code>int2.formula</code> or <code>int3.formula</code>, this option is ignored.
<code>screen</code> should be used only when users want data-driven selection of
factor-interactions. With <code>screen.type</code>, users can specify how to
screen factor interactions. We recommend to use this option when the number
of factors is large, e.g., more than 6. Default is <code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>screen.type</code></td>
<td>
<p>Type for screening factor interactions. (1)
<code>"fixed"</code> select the fixed number (specified by <code>screen.num.int</code>)
of factor interactions. (2) <code>"cv.min"</code> selects factor-interactions with
the tuning parameter giving the minimum cross-validation error. (3)
<code>"cv.1Std"</code> selects factor-interactions with the tuning parameter
giving a cross-validation error that is within 1 standard deviation of the
minimum cv error.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>screen.num.int</code></td>
<td>
<p>(optional).The number of factor interactions to
select. This option is used when and <code>screen=TRUE</code> and
<code>screen.type="fixed"</code>. Default is 3.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>collapse</code></td>
<td>
<p>A logical indicating whether to collapse insignificant
levels within factors.  With <code>collapse.type</code>, users can specify how to
collapse levels within factors. We recommend to use this option when the
number of levels is large, e.g., more than 6. Default is <code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>collapse.type</code></td>
<td>
<p>Type for collapsing levels within factors. (1)
<code>"fixed"</code> collapses levels with the fixed cost parameter (specified by
<code>collapse.cost</code>). (2) <code>"cv.min"</code> collapses levels with the cost
parameter giving the minimum cross-validation error. This option might take
time. (3) <code>"cv.1Std"</code> collapses with the cost parameter giving a
cross-validation error that is within 1 standard deviation of the minimum cv
error. This option might take time.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>collapse.cost</code></td>
<td>
<p>(optional).A cost parameter ranging from 0 to 1. 1
corresponds to no collapsing. The closer to 0, the stronger regularization.
Default is 0.3.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>family</code></td>
<td>
<p>A family of outcome variables. <code>"gaussian"</code> when
continuous outcomes <code>"binomial"</code> when binary outcomes.  Default is
<code>"binomial"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cluster</code></td>
<td>
<p>Unique identifies with which cluster standard errors are
computed.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>maxIter</code></td>
<td>
<p>The number of maximum iteration for <code>glinternet</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>eps</code></td>
<td>
<p>A tolerance parameter in the internal optimization algorithm.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fac.level</code></td>
<td>
<p>(optional). A vector containing the number of levels in
each factor. The order of <code>fac.level</code> should match to the order of
columns in the data. For example, when the first and second columns of the
design matrix is "Education" and "Race", the first and second element of
<code>fac.level</code> should be the number of levels in "Education" and "Race",
respectively.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ord.fac</code></td>
<td>
<p>(optional). Logical vectors indicating whether each factor
has ordered (<code>TRUE</code>) or unordered (<code>FALSE</code>) levels.  When levels
are ordered, the function uses the order given by function <code>levels()</code>.
If levels are ordered, the function places penalties on the differences
between adjacent levels.  If levels are unordered, the function places
penalties on the differences based on every pairwise comparison.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>select.prob</code></td>
<td>
<p>(optional). A logical indicating whether selection
probabilities are computed. This option might take time.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>boot</code></td>
<td>
<p>The number of bootstrap replicates for <code>select.prob</code>.
Default is 50.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>seed</code></td>
<td>
<p>Seed for bootstrap.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>Whether it prints the value of a cost parameter used.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p><b>Regularization</b>: <code>screen</code> and <code>collapse</code>.
</p>
<p>Users can implement regularization in order to reduces false discovery rate
and facilitates interpretation. This is particularly useful when analyzing
factorial experiments with a large number of factors, each having many
levels.  </p>
 <ul>
<li>
<p> When <code>screen=TRUE</code>, the function selects
significant factor interactions with <code>glinternet</code> (Lim and Hastie 2015)
before estimating the AMEs and AMIEs. This option is recommended when there
are many factors, e.g., more than 6 factors. Alternatively, users can
pre-specify interactions of interest using <code>int2.formula</code> and
<code>int3.formula</code>. </p>
</li>
<li>
<p> When <code>collapse=TRUE</code>, the function collapses
insignificant levels within each factor by GashANOVA (Post and Bondell 2013)
before estimating the AMEs and AMIEs. This option is recommended when there
are many levels within some factors, e.g., more than 6 levels. </p>
</li>
</ul>
<p><b>Inference after Regularization</b>: </p>
 <ul>
<li>
<p> When <code>screen=TRUE</code> or
<code>collapse=TRUE</code>, in order to make valid inference after regularization,
we recommend to use <code>test.CausalANOVA</code> function. It takes the output
from <code>CausalANOVA</code> function and estimate the AMEs and AMIEs with
<code>newdata</code> and provide confidence intervals. Ideally, users should split
samples into two; use a half for regularization with <code>CausalANOVA</code>
function and use the other half for inference with <code>test.CausalANOVA</code>.
</p>
</li>
<li>
<p> If users do not need regularization, specify <code>screen=FALSE</code> and
<code>collapse=FALSE</code>. The function estimates the AMEs and AMIEs and compute
confidence intervals with the full sample. </p>
</li>
</ul>
<p><b>Suggested Workflow</b>: (See Examples below as well) </p>
 <ol>
<li>
<p> Specify
the order of levels within each factor using <code>levels()</code>.  When
<code>collapse=TRUE</code>, the function places penalties on the differences
between adjacent levels when levels are ordered, it is crucial to specify
the order of levels within each factor carefully. </p>
</li>
<li>
<p> Run
<code>CausalANOVA</code>. </p>
 <ol>
<li>
<p> Specify <code>formula</code> to indicate
outcomes and treatment variables and <code>nway</code> to indicate the order of
interactions. </p>
</li>
<li>
<p> Specify <code>diff=TRUE</code> and <code>pair.id</code> if the
outcome is the choice between a pair. </p>
</li>
<li>
<p> Specify <code>screen</code>.
<code>screen=TRUE</code> to implement data-driven selection of factor
interactions. <code>screen=FALSE</code> to specify interactions through
<code>int2.formula</code> and <code>int3.formula</code> by hand. </p>
</li>
<li>
<p> Specify
<code>collapse</code>. <code>collapse=TRUE</code> to implement data-driven collapsing of
insignificant levels. <code>collapse=FALSE</code> to use the original number of
levels.</p>
</li>
</ol>
</li>
<li>
<p> Run <code>test.CausalANOVA</code> when <code>select=TRUE</code> or
<code>collapse=TRUE</code>.  </p>
</li>
<li>
<p> Run <code>summary</code> and <code>plot</code> to explore
the AMEs and AMIEs. </p>
</li>
<li>
<p> Estimate conditional effects using
<code>ConditionalEffect</code> function and visualize them using <code>plot</code>
function. </p>
</li>
</ol>
<h3>Value</h3>

<table>
<tr style="vertical-align: top;">
<td><code>intercept</code></td>
<td>
<p>An intercept of the estimated ANOVA model.If
<code>diff=TRUE</code>, this should be close to 0.5.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>
<p>The
<code>formula</code> used in the function.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>coefs</code></td>
<td>
<p>A named vector of
coefficients of the estimated ANOVA model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>vcov</code></td>
<td>
<p>The
variance-covariance matrix for <code>coefs</code>. Only when <code>select=FALSE</code>
and <code>collapse=FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CI.table</code></td>
<td>
<p>The summary of AMEs and AMIEs
with confidence intervals. Only when <code>select=FALSE</code> and
<code>collapse=FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>AME</code></td>
<td>
<p>The estimated AMEs with the grand-mean as
baselines.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>AMIE2</code></td>
<td>
<p>The estimated two-way AMIEs with the grand-mean as
baselines.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>AMIE3</code></td>
<td>
<p>The estimated three-way AMIEs with the grand-mean
as baselines.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>arguments passed to the function or arguments only
for the internal use.</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Naoki Egami and Kosuke Imai.
</p>


<h3>References</h3>

<p>Egami, Naoki and Kosuke Imai. 2019. Causal Interaction in
Factorial Experiments: Application to Conjoint Analysis, Journal of the American Statistical Association.
<a href="http://imai.fas.harvard.edu/research/files/int.pdf">http://imai.fas.harvard.edu/research/files/int.pdf</a>
</p>
<p>Lim, M. and Hastie, T. 2015. Learning interactions via hierarchical
group-lasso regularization. Journal of Computational and Graphical
Statistics 24, 3, 627–654.
</p>
<p>Post, J. B. and Bondell, H. D. 2013. Factor selection and structural
identification in the interaction anova model. Biometrics 69, 1, 70–79.
</p>


<h3>See Also</h3>

<p>cv.CausalANOVA
</p>


<h3>Examples</h3>

<pre><code class="language-R">
data(Carlson)
## Specify the order of each factor
Carlson$newRecordF&lt;- factor(Carlson$newRecordF,ordered=TRUE,
                            levels=c("YesLC", "YesDis","YesMP",
                                     "noLC","noDis","noMP","noBusi"))
Carlson$promise &lt;- factor(Carlson$promise,ordered=TRUE,levels=c("jobs","clinic","education"))
Carlson$coeth_voting &lt;- factor(Carlson$coeth_voting,ordered=FALSE,levels=c("0","1"))
Carlson$relevantdegree &lt;- factor(Carlson$relevantdegree,ordered=FALSE,levels=c("0","1"))

## ####################################### 
## Without Screening and Collapsing
## ####################################### 
#################### only AMEs ####################
fit1 &lt;- CausalANOVA(formula=won ~ newRecordF + promise + coeth_voting + relevantdegree,
                    data=Carlson, pair.id=Carlson$contestresp, diff=TRUE,
                    cluster=Carlson$respcodeS, nway=1)
summary(fit1)
plot(fit1)

#################### AMEs and two-way AMIEs ####################
fit2 &lt;- CausalANOVA(formula=won ~ newRecordF + promise + coeth_voting + relevantdegree,
                    int2.formula = ~ newRecordF:coeth_voting,
                    data=Carlson, pair.id=Carlson$contestresp,diff=TRUE,
                    cluster=Carlson$respcodeS, nway=2)
summary(fit2)
plot(fit2, type="ConditionalEffect", fac.name=c("newRecordF","coeth_voting"))
ConditionalEffect(fit2, treat.fac="newRecordF", cond.fac="coeth_voting")

## Not run: 
#################### AMEs and two-way and three-way AMIEs ####################
## Note: All pairs within thee-way interactions should show up in int2.formula (Strong Hierarchy).
fit3 &lt;- CausalANOVA(formula=won ~ newRecordF + promise + coeth_voting + relevantdegree,
                    int2.formula = ~ newRecordF:promise + newRecordF:coeth_voting
                                       + promise:coeth_voting,
                    int3.formula = ~ newRecordF:promise:coeth_voting,
                    data=Carlson, pair.id=Carlson$contestresp,diff=TRUE,
                    cluster=Carlson$respcodeS, nway=3)
summary(fit3)
plot(fit3, type="AMIE", fac.name=c("newRecordF","promise", "coeth_voting"),space=25,adj.p=2.2)

## End(Not run)

## ####################################### 
## With Screening and Collapsing
## #######################################
## Sample Splitting
train.ind &lt;- sample(unique(Carlson$respcodeS), 272, replace=FALSE)
test.ind &lt;- setdiff(unique(Carlson$respcodeS), train.ind)
Carlson.train &lt;- Carlson[is.element(Carlson$respcodeS,train.ind), ]
Carlson.test &lt;- Carlson[is.element(Carlson$respcodeS,test.ind), ]
 
#################### AMEs and two-way AMIEs ####################
fit.r2 &lt;- CausalANOVA(formula=won ~ newRecordF + promise + coeth_voting + relevantdegree,
                      data=Carlson.train, pair.id=Carlson.train$contestresp,diff=TRUE,
                      screen=TRUE, collapse=TRUE,
                      cluster=Carlson.train$respcodeS, nway=2)
summary(fit.r2)

## refit with test.CausalANOVA
fit.r2.new &lt;- test.CausalANOVA(fit.r2, newdata=Carlson.test, diff=TRUE,
                               pair.id=Carlson.test$contestresp, cluster=Carlson.test$respcodeS)

summary(fit.r2.new)
plot(fit.r2.new)
plot(fit.r2.new, type="ConditionalEffect", fac.name=c("newRecordF","coeth_voting"))
ConditionalEffect(fit.r2.new, treat.fac="newRecordF", cond.fac="coeth_voting")

</code></pre>


</div>