<div class="container">

<table style="width: 100%;"><tr>
<td>GnE</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Penalized factorial regression using glmnet</h2>

<h3>Description</h3>

<script id="MathJax-script" async src="../../mathjaxr/doc/mathjax/es5/tex-chtml-full.js"></script><p>Based on multi-environment field trials, fits the factorial regression model
\(Y_{ij} = \mu + e_j + g_i + \sum_{k=1}^s \beta_{ik} x_{ij} +
\epsilon_{ij},\) with environmental main effects \(e_j\),
genotypic main effects \(g_{i}\) and genotype-specific
environmental sensitivities \(\beta_{ik}\). See e.g. Millet
et al 2019 and Bustos-Korts et al 2019. There are \(s\)
environmental indices with values \(x_{ij}\). Optionally,
predictions can be made for a set of test environments, for which
environmental indices are available. The new environments must contain the
same set of genotypes, or a subset.
</p>
<p>Penalization: the model above is fitted using glmnet, simultaneously
penalizing \(e_j\), \(g_i\) and
\(\beta_{ik}\). If <code>penG = 0</code> and <code>penE = 0</code>, the main
effects \(g_i\) and \(e_j\) are not penalized. If these
parameters are 1, the the main effects are penalized to the same degree as
the sensitivities. Any non negative values are allowed. Cross validation is
performed with each fold containing a number of environments (details below).
</p>
<p>After fitting the model, it is possible to replace the estimated
genotypic main effects and sensitivities by
their predicted genetic values. Specifically, if a kinship matrix <code>K</code>
is assigned the function performs genomic prediction with g-BLUP for the
genotypic main effect and each of the sensitivities in turn.
</p>
<p>Predictions for the test environments are first constructed using the
estimated genotypic main effects and sensitivities; next, predicted
environmental main effects are added. The latter are obtained by
regressing the estimated environmental main effects for the training
environments on the average values of the indices in these environments,
as in Millet et al. 2019.
</p>


<h3>Usage</h3>

<pre><code class="language-R">GnE(
  dat,
  Y,
  G,
  E,
  K = NULL,
  indices = NULL,
  indicesData = NULL,
  testEnv = NULL,
  weight = NULL,
  outputFile = NULL,
  corType = c("pearson", "spearman"),
  partition = data.frame(),
  nfolds = 10,
  alpha = 1,
  lambda = NULL,
  penG = 0,
  penE = 0,
  scaling = c("train", "all", "no"),
  quadratic = FALSE,
  verbose = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>dat</code></td>
<td>
<p>A <code>data.frame</code> with data from multi-environment trials.
Each row corresponds to a particular genotype in a particular environment.
The data do not need to be balanced, i.e. an environment does not need to
contain all genotypes. <code>dat</code> should contain the training as well as the
test environments (see testEnv)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Y</code></td>
<td>
<p>The trait to be analyzed: either of type character, in which case
it should be one of the column names in <code>dat</code>, or numeric, in which
case the Yth column of <code>dat</code> will be analyzed.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>G</code></td>
<td>
<p>The column in <code>dat</code> containing the factor genotype (either
character or numeric).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>E</code></td>
<td>
<p>The column in <code>dat</code> containing the factor environment
(either character or numeric).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>K</code></td>
<td>
<p>A kinship matrix. Used for replacing the estimated genotypic main
effect and each of the sensitivities by genomic prediction from a g-BLUP
model for each of them. If <code>NULL</code>, the estimated effects from the model
are returned and used for constructing predictions.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>indices</code></td>
<td>
<p>The columns in <code>dat</code> containing the environmental
indices (vector of type character). Alternatively, if the indices are always
constant within environments (i.e. not genotype dependent), the
environmental data can also be provided using the argument <code>indicesData</code>
(see below).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>indicesData</code></td>
<td>
<p>An optional <code>data.frame</code> containing environmental
indices (covariates); one value for each environment and index. It should
have the environment names as row names (corresponding to the names
contained in <code>dat$E</code>); the column names are the indices. If
<code>indices</code> (see before) is also provided, the latter will be ignored.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>testEnv</code></td>
<td>
<p>vector (character). Data from these environments are not used
for fitting the model. Accuracy is evaluated for training and test
environments separately. The default is <code>NULL</code>, i.e. no test
environments, in which case the whole data set is training. It is also
possible that there are test environments, but without any data; in this
case, no accuracy is reported for test environments (CHECK correctness).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weight</code></td>
<td>
<p>Numeric vector of length <code>nrow(dat)</code>, specifying the
weight (inverse variance) of each observation, used in glmnet. Default
<code>NULL</code>, giving constant weights.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>outputFile</code></td>
<td>
<p>The file name of the output files, without .csv extension
which is added by the function. If not <code>NULL</code> the prediction accuracies
for training and test environments are written to separate files. If
<code>NULL</code> the output is not written to file.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>corType</code></td>
<td>
<p>type of correlation: Pearson (default) or Spearman rank sum.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>partition</code></td>
<td>
<p><code>data.frame</code> with columns E and partition. The column
E should contain the training environments (type character); partition
should be of type integer. Environments in the same fold should have
the same integer value. Default is <code>data.frame()</code>, in which case the
function uses a leave-one-environment out cross-validation. If <code>NULL</code>,
the (inner) training sets used for cross-validation will be drawn randomly
from all observations, ignoring the environment structure. In the latter
case, the number of folds (nfolds) can be specified.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nfolds</code></td>
<td>
<p>Default <code>NULL</code>. If <code>partition == NULL</code>, this can be
used to specify the number of folds to be used in glmnet.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha</code></td>
<td>
<p>Type of penalty, as in glmnet (1 = LASSO, 0 = ridge; in between
= elastic net). Default is 1.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lambda</code></td>
<td>
<p>Numeric vector; defines the grid over which the penalty lambda
is optimized in cross validation. Default: NULL (defined by glmnet).
Important special case: lambda = 0 (no penalty).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>penG</code></td>
<td>
<p>numeric; default 0. If 1, genotypic main effects are
penalized. If 0, they are not. Any non negative real number is allowed.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>penE</code></td>
<td>
<p>numeric; default 0. If 1, environmental main effects are
penalized. If 0, they are not. Any non negative real number is allowed.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>scaling</code></td>
<td>
<p>determines how the environmental variables are scaled.
"train" : all data (test and training environments) are scaled
using the mean and and standard deviation in the training environments.
"all" : using the mean and standard deviation of all environments.
"no" : No scaling.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>quadratic</code></td>
<td>
<p>boolean; default <code>FALSE</code>. If <code>TRUE</code>, quadratic
terms (i.e., squared indices) are added to the model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>boolean; default <code>FALSE</code>. If <code>TRUE</code>, the accuracies
per environment are printed on screen.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>A list with the following elements:
</p>

<dl>
<dt>predTrain</dt>
<dd>
<p>A data.frame with predictions for the training set</p>
</dd>
<dt>predTest</dt>
<dd>
<p>A data.frame with predictions for the test set</p>
</dd>
<dt>resTrain</dt>
<dd>
<p>A data.frame with residuals for the training set</p>
</dd>
<dt>resTest</dt>
<dd>
<p>A data.frame with residuals for the test set</p>
</dd>
<dt>mu</dt>
<dd>
<p>the estimated overall mean</p>
</dd>
<dt>envInfoTrain</dt>
<dd>
<p>The estimated environmental main effects, and the
predicted effects, obtained when the former are regressed on the averaged
indices, using penalized regression</p>
</dd>
<dt>envInfoTest</dt>
<dd>
<p>The predicted environmental main effects for the test
environments, obtained from penalized regression using the estimated
main effects for the training environments and the averaged indices</p>
</dd>
<dt>parGeno</dt>
<dd>
<p>data.frame containing the estimated genotypic main effects
(first column) and sensitivities (subsequent columns)</p>
</dd>
<dt>trainAccuracyEnv</dt>
<dd>
<p>a data.frame with the accuracy (r) for each
training environment, as well as the root mean square error (RMSE), mean
absolute deviation (MAD) and rank (the latter is a proportion: how many
of the best 5 genotypes are in the top 10). To be removed or further
developed. All these quantities are also evaluated for a model with only
genotypic and environmental main effects (columns rMain, RMSEMain and
rankMain)</p>
</dd>
<dt>testAccuracyEnv</dt>
<dd>
<p>A data.frame with the accuracy for each test
environment, with the same columns as trainAccuracyEnv</p>
</dd>
<dt>trainAccuracyGeno</dt>
<dd>
<p>a data.frame with the accuracy (r) for each
genotype, averaged over the training environments</p>
</dd>
<dt>testAccuracyGeno</dt>
<dd>
<p>a data.frame with the accuracy (r) for each
genotype, averaged over the test environments</p>
</dd>
<dt>lambda</dt>
<dd>
<p>The value of lambda selected using cross validation</p>
</dd>
<dt>lambdaSequence</dt>
<dd>
<p>The values of lambda used in the fits of glmnet. If
<code>lambda</code> was provided as input, the value of <code>lambda</code> is
returned</p>
</dd>
<dt>RMSEtrain</dt>
<dd>
<p>The root mean squared error on the training environments</p>
</dd>
<dt>RMSEtest</dt>
<dd>
<p>The root mean squared error on the test environments</p>
</dd>
<dt>Y</dt>
<dd>
<p>The name of the trait that was predicted, i.e. the column name
in <code>dat</code> that was used</p>
</dd>
<dt>G</dt>
<dd>
<p>The genotype label that was used, i.e. the argument G that was
used</p>
</dd>
<dt>E</dt>
<dd>
<p>The environment label that was used, i.e. the argument E that
was used</p>
</dd>
<dt>indices</dt>
<dd>
<p>The indices that were used, i.e. the argument indices that
was used</p>
</dd>
<dt>quadratic</dt>
<dd>
<p>The quadratic option that was used</p>
</dd>
</dl>
<h3>References</h3>

<p>Millet, E.J., Kruijer, W., Coupel-Ledru, A. et al. Genomic
prediction of maize yield across European environmental conditions. Nat
Genet 51, 952–956 (2019). <a href="https://doi.org/10.1038/s41588-019-0414-y">doi:10.1038/s41588-019-0414-y</a>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## load the data, which are contained in the package
data(drops_GE)
data(drops_GnE)

## We remove identifiers that we don't need.
drops_GE_GnE &lt;- rbind(drops_GE[, -c(2, 4)], drops_GnE[, -c(2, 4)])

## Define indeces.
ind &lt;- colnames(drops_GE)[13:23]

## Define test environments.
testenv &lt;- levels(drops_GnE$Experiment)

## Additive model, only main effects (set the penalty parameter to a large value).
Additive_model &lt;- GnE(drops_GE_GnE, Y = "grain.yield", lambda = 100000,
                      G = "Variety_ID", E = "Experiment", testEnv = testenv,
                      indices = ind, penG = FALSE, penE = FALSE,
                      alpha = 0.5, scaling = "train")

## Full model, no penalization (set the penalty parameter to zero).
Full_model &lt;- GnE(drops_GE_GnE, Y = "grain.yield", lambda = 0,
                  G = "Variety_ID", E = "Experiment", testEnv = testenv,
                  indices = ind, penG = FALSE, penE = FALSE,
                  alpha = 0.5, scaling = "train")

## Elastic Net model, set alpha parameter to 0.5.
Elnet_model &lt;- GnE(drops_GE_GnE, Y = "grain.yield", lambda = NULL,
                   G = "Variety_ID", E = "Experiment", testEnv = testenv,
                   indices = ind, penG = FALSE, penE = FALSE,
                   alpha = 0.5, scaling = "train")

## Lasso model, set alpha parameter to 1.
Lasso_model &lt;- GnE(drops_GE_GnE, Y = "grain.yield", lambda = NULL,
                   G = "Variety_ID", E = "Experiment", testEnv = testenv,
                   indices = ind, penG = FALSE, penE = FALSE,
                   alpha = 1, scaling = "train")

## Ridge model, set alpha parameter to 0.
Ridge_model &lt;- GnE(drops_GE_GnE, Y = "grain.yield", lambda = NULL,
                   G = "Variety_ID", E = "Experiment", testEnv = testenv,
                   indices = ind, penG = FALSE, penE = FALSE,
                   alpha = 0, scaling = "train")


</code></pre>


</div>