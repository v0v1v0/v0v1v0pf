<div class="container">

<table style="width: 100%;"><tr>
<td>fcr</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Fit Functional Concurrent Regression</h2>

<h3>Description</h3>

<p>This function implements functional concurrent regression for sparse functional responses with both functional and scalar covariates.
This function is a wrapper for mgcv's <code>gam</code>/<code>bam</code>.
</p>


<h3>Usage</h3>

<pre><code class="language-R">fcr(formula, argvals, subj, argvals.new = NULL, data = NULL, niter = 1,
  sp = FALSE, nPhi = NULL, use_bam = FALSE, discrete = FALSE,
  face.args = list(knots = 12, lower = -3, pve = 0.95), ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>
<p>formula will accept any input formula which is valid for <code>gam</code>.
The formula should only include terms not associated with the random function intercept b_i(t_ij). See Examples.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>argvals</code></td>
<td>
<p>a string indicating the functional domain variable name in data</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>subj</code></td>
<td>
<p>a string indicating the unique subject identifier name in data</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>argvals.new</code></td>
<td>
<p>new values of the functional domanin to predict using <code>face.sparse</code>, optional
if one desires to predict at points of the functional domain not included in the data fitting procedure,
they must be supplied in this argument.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>dataframe including all variables of interest. Must not have any missing data for variables used in model fitting.
data must also not contain any variables named: "g", "phi" followed by any numbers, or "sp" followed by any numbers. These
names are reserved for the fitting procedure.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>niter</code></td>
<td>
<p>number of times to iterate the covariance estimation</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sp</code></td>
<td>
<p>logical arguement indicating whether smoothing parameters for random effects should be supplied to
<code>gam</code> or <code>bam</code> using estimates from <code>face.sparse</code>
(TRUE), or whether smoothing parameters for random effects should
be estimated by mgcv (FALSE). Defaults to FALSE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nPhi</code></td>
<td>
<p>number of random effects to include in final model (i.e. number of eigenfunctions of the covariance function).
Default value (NULL) results in the use of all estimated random effects.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>use_bam</code></td>
<td>
<p>logical argument indicating whether to use <code>gam</code> or <code>bam</code>.
For moderate or large number of eigenfunctions
it is recommended to use <code>bam</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>discrete</code></td>
<td>
<p>logical argument indicating whether whether to supple discrete = TRUE argument to <code>bam</code>.
This argument may reduce computation time, but is currently listed as “experimental". Not available when use_bam = FALSE.
Defaults to FALSE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>face.args</code></td>
<td>
<p>list of arguments to pass to <code>face.sparse</code>. Can not pass the arguments “data", “newdata", “center" or “argvals.new"
as these are determined by the procedure.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>arguments to be passed to mgcv::gam()/bam()</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The models fit are of the form
</p>
<p style="text-align: center;"><code class="reqn">y = f_0(t_{ij}) + f_1(t_{ij})X_{ij} + ... + b_i(t_{ij}) + \epsilon_{ij}</code>
</p>

<p>Note that this function will accept any valid formula for <code>gam</code>/<code>bam</code>.
However, only the identity link function is available at this time.
See the package vignettes for additional descriptions of dynamic prediction and the class of models fit by this function.
</p>


<h3>Value</h3>

<p>An object of class <code>fcr</code> containing five elements
</p>

<dl>
<dt>fit</dt>
<dd>
<p>An object corresponding to the fitted model from the mgcv package</p>
</dd>
<dt>face.object</dt>
<dd>
<p>An object corresponding to the estimated covariance features</p>
</dd>
<dt>runtime</dt>
<dd>
<p>Model fitting time</p>
</dd>
<dt>argvals</dt>
<dd>
<p>Character scalar corresponding the name of the functional domain variable</p>
</dd>
<dt>runtime</dt>
<dd>
<p>logical scalar corresponding to sp argument used in model fitting</p>
</dd>
</dl>
<h3>References</h3>

<p>Jaganath D, Saito M Giman RH Queirox DM, Rocha GA, Cama V, Cabrera L, Kelleher D, Windle HJ,
Crabtree JE, Jean E, Checkley W. First Detected Helicobacter pylori Infection in Infancy Modifies the
Association Between Diarrheal Disease and Childhood Growth in Peru. Helicobacter (2014); 19:272-297.
</p>
<p>Leroux A, Xiao L, Crainiceanu C, Checkley W (2017). Dynamic prediction in functional concurrent
regression with an application to child growth.
</p>
<p>Xiao L, Li C, Checkley W, Crainiceanu C. Fast covariance estimation for sparse functional data.
Statistics and Computing, (2017).
</p>


<h3>Examples</h3>

<pre><code class="language-R">





data &lt;- content
## smoothing parameters
k &lt;- 12  # number of interior knots for fpca (results in k + 3 basis functions)
K &lt;- 15 # dimenson of smooth for time varying coefficients

## functional domain where we need predictions
tnew &lt;- sort(unique(data$argvals))

###########################################
## Step 1: Smooth time-varying covariate ##
###########################################
dat.waz &lt;- data.frame("y" = data$waz, "subj" = data$subj, argvals = data$argvals)
fit.waz &lt;- face.sparse(dat.waz, newdata = dat.waz, knots = k, argvals.new = tnew)
data$wazPred &lt;- fit.waz$y.pred


#####################
## Step 2: Fit fcr ##
#####################
fit &lt;- fcr(formula = Y ~ s(argvals, k=K, bs="ps") +
                         s(argvals, by=Male, k=K, bs="ps") +
                         s(argvals, by=wazPred, bs="ps"),
           argvals = "argvals", subj="subj", data=data, use_bam=TRUE, argvals.new=tnew,
           face.args = list(knots=k, pve=0.99))

## plot covariance features
plot(fit, plot.covariance=TRUE)

## plot coefficient functions and qq plots for random effects
plot(fit)

########################
## Step 3: Prediction ##
########################
## data frames for in-sample and dynamic predictions
data_dyn &lt;- data_in &lt;- data

## change subject IDs to values not used in model fitting
## for dynamic prediction
data_dyn$subj &lt;- data_dyn$subj + 1000

## make all observations beyond 0.5 NA in both data frames
## and dynamically predict the concurrent covariate in
## dynamic prediction
inx_na &lt;- which(data_dyn$argvals &gt; 0.5)
data_dyn$Y[inx_na] &lt;- data_dyn$waz[inx_na] &lt;- NA
data_dyn$wazPred &lt;- predict(fit.waz,
                            newdata= data.frame("subj" = data_dyn$subj,
                                                "argvals" = data_dyn$argvals,
                                                "y" = data_dyn$Y))$y.pred

data_in$Y[inx_na]  &lt;- NA


## in sample and dynamic predictions on the same subjects
insample_preds  &lt;- predict(fit, newdata = data)
dynamic_preds   &lt;- predict(fit, newdata = data_dyn)



</code></pre>


</div>