<div class="container">

<table style="width: 100%;"><tr>
<td>flexsurvspline</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Flexible survival regression using the Royston/Parmar spline model.</h2>

<h3>Description</h3>

<p>Flexible parametric modelling of time-to-event data using the spline model
of Royston and Parmar (2002).
</p>


<h3>Usage</h3>

<pre><code class="language-R">flexsurvspline(
  formula,
  data,
  weights,
  bhazard,
  rtrunc,
  subset,
  k = 0,
  knots = NULL,
  bknots = NULL,
  scale = "hazard",
  timescale = "log",
  spline = "rp",
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>
<p>A formula expression in conventional R linear modelling
syntax. The response must be a survival object as returned by the
<code>Surv</code> function, and any covariates are given on the right-hand
side.  For example,
</p>
<p><code>Surv(time, dead) ~ age + sex</code>
</p>
<p>specifies a model where the log cumulative hazard (by default, see
<code>scale</code>) is a linear function of the covariates <code>age</code> and
<code>sex</code>.
</p>
<p>If there are no covariates, specify <code>1</code> on the right hand side, for
example <code>Surv(time, dead) ~ 1</code>.
</p>
<p>Time-varying covariate effects can be specified using the method described
in <code>flexsurvreg</code> for placing covariates on ancillary
parameters.  The ancillary parameters here are named <code>gamma1</code>,
..., <code>gammar</code> where <code>r</code> is the number of knots <code>k</code> plus
one (the “degrees of freedom” as defined by Royston and Parmar).  So for
the default Weibull model, there is just one ancillary parameter
<code>gamma1</code>.
</p>
<p>Therefore a model with one internal spline knot, where the equivalents of
the Weibull shape and scale parameters, but not the higher-order term
<code>gamma2</code>, vary with age and sex, can be specified as:
</p>
<p><code>Surv(time, dead) ~ age + sex + gamma1(age) + gamma1(sex)</code>
</p>
<p>or alternatively (and more safely, see <code>flexsurvreg</code>)
</p>
<p><code>Surv(time, dead) ~ age + sex, anc=list(gamma1=~age + sex)</code>
</p>
<p><code>Surv</code> objects of <code>type="right"</code>,<code>"counting"</code>,
<code>"interval1"</code> or <code>"interval2"</code> are supported, corresponding to
right-censored, left-truncated or interval-censored observations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>A data frame in which to find variables supplied in
<code>formula</code>.  If not given, the variables should be in the working
environment.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weights</code></td>
<td>
<p>Optional variable giving case weights.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bhazard</code></td>
<td>
<p>Optional variable giving expected hazards for relative
survival models.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>rtrunc</code></td>
<td>
<p>Optional variable giving individual right-truncation times (see <code>flexsurvreg</code>).  Note that these models can suffer from weakly identifiable parameters and
badly-behaved likelihood functions, and it is advised to compare
convergence for different initial values by supplying different
<code>inits</code> arguments to <code>flexsurvspline</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>subset</code></td>
<td>
<p>Vector of integers or logicals specifying the subset of the
observations to be used in the fit.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>k</code></td>
<td>
<p>Number of knots in the spline. The default <code>k=0</code> gives a
Weibull, log-logistic or lognormal model, if <code>"scale"</code> is
<code>"hazard"</code>, <code>"odds"</code> or <code>"normal"</code> respectively.  <code>k</code>
is equivalent to <code>df-1</code> in the notation of <code>stpm</code> for Stata.  The
knots are then chosen as equally-spaced quantiles of the log uncensored
survival times, for example, at the median with one knot, or at the 33%
and 67% quantiles of log time (or time, see <code>"timescale"</code>) with two
knots.  To override this default knot placement, specify <code>knots</code>
instead.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>knots</code></td>
<td>
<p>Locations of knots on the axis of log time (or time, see
<code>"timescale"</code>).  If not specified, knot locations are chosen as
described in <code>k</code> above.  Either <code>k</code> or <code>knots</code> must be
specified. If both are specified, <code>knots</code> overrides <code>k</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bknots</code></td>
<td>
<p>Locations of boundary knots, on the axis of log time (or
time, see <code>"timescale"</code>).  If not supplied, these are are chosen as
the minimum and maximum log death time.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>scale</code></td>
<td>
<p>If <code>"hazard"</code>, the log cumulative hazard is modelled as a
spline function.
</p>
<p>If <code>"odds"</code>, the log cumulative odds is modelled as a spline function.
</p>
<p>If <code>"normal"</code>, <code class="reqn">-\Phi^{-1}(S(t))</code> is modelled as a
spline function, where <code class="reqn">\Phi^{-1}()</code> is the inverse normal
distribution function <code>qnorm</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>timescale</code></td>
<td>
<p>If <code>"log"</code> (the default) the log cumulative hazard
(or alternative) is modelled as a spline function of log time.  If
<code>"identity"</code>, it is modelled as a spline function of time, however
this model would not satisfy the desirable property that the cumulative hazard
(or alternative) should approach 0 at time zero.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>spline</code></td>
<td>
<p><code>"rp"</code> to use the natural cubic spline basis
described in Royston and Parmar.
</p>
<p><code>"splines2ns"</code> to use the alternative natural cubic spline
basis from the <code>splines2</code> package (Wang and Yan 2021),
which may be better behaved due to the basis being orthogonal.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Any other arguments to be passed to or through
<code>flexsurvreg</code>, for example, <code>anc</code>, <code>inits</code>,
<code>fixedpars</code>, <code>weights</code>, <code>subset</code>, <code>na.action</code>, and any
options to control optimisation.  See <code>flexsurvreg</code>.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>This function works as a wrapper around <code>flexsurvreg</code> by
dynamically constructing a custom distribution using
<code>dsurvspline</code>, <code>psurvspline</code> and
<code>unroll.function</code>.
</p>
<p>In the spline-based survival model of Royston and Parmar (2002), a
transformation <code class="reqn">g(S(t,z))</code> of the survival function is modelled as a
natural cubic spline function of log time <code class="reqn">x = \log(t)</code>
plus linear effects of covariates <code class="reqn">z</code>.
</p>
<p style="text-align: center;"><code class="reqn">g(S(t,z)) = s(x, \bm{\gamma}) + \bm{\beta}^T \mathbf{z}</code>
</p>

<p>The proportional hazards model (<code>scale="hazard"</code>) defines
<code class="reqn">g(S(t,\mathbf{z})) = \log(-\log(S(t,\mathbf{z}))) =
\log(H(t,\mathbf{z}))</code>, the
log cumulative hazard.
</p>
<p>The proportional odds model (<code>scale="odds"</code>) defines
<code class="reqn">g(S(t,\mathbf{z})) </code><code class="reqn"> =
\log(S(t,\mathbf{z})^{-1} - 1)</code>, the log
cumulative odds.
</p>
<p>The probit model (<code>scale="normal"</code>) defines <code class="reqn">g(S(t,\mathbf{z})) =
</code><code class="reqn"> -\Phi^{-1}(S(t,\mathbf{z}))</code>, where <code class="reqn">\Phi^{-1}()</code> is the inverse normal
distribution function <code>qnorm</code>.
</p>
<p>With no knots, the spline reduces to a linear function, and these models
are equivalent to Weibull, log-logistic and lognormal models respectively.
</p>
<p>The spline coefficients <code class="reqn">\gamma_j: j=1, 2 \ldots </code>, which are called the "ancillary parameters" above, may also be
modelled as linear functions of covariates <code class="reqn">\mathbf{z}</code>, as
</p>
<p style="text-align: center;"><code class="reqn">\gamma_j(\mathbf{z}) = \gamma_{j0} + \gamma_{j1}z_1 + \gamma_{j2}z_2
+ ... </code>
</p>

<p>giving a model where the effects of covariates are arbitrarily flexible
functions of time: a non-proportional hazards or odds model.
</p>
<p>Natural cubic splines are cubic splines constrained to be linear beyond
boundary knots <code class="reqn">k_{min},k_{max}</code>.  The spline function is
defined as
</p>
<p style="text-align: center;"><code class="reqn">s(x,\boldsymbol{\gamma}) = \gamma_0 + \gamma_1 x + \gamma_2 v_1(x) + \ldots +
</code>
</p>
<p style="text-align: center;"><code class="reqn"> \gamma_{m+1} v_m(x)</code>
</p>

<p>where <code class="reqn">v_j(x)</code> is the <code class="reqn">j</code>th basis function
</p>
<p style="text-align: center;"><code class="reqn">v_j(x) = (x - k_j)^3_+ - \lambda_j(x - k_{min})^3_+ - (1 - </code>
</p>
<p style="text-align: center;"><code class="reqn"> \lambda_j) (x - k_{max})^3_+</code>
</p>

<p style="text-align: center;"><code class="reqn">\lambda_j = \frac{k_{max} - k_j}{k_{max} - k_{min}}</code>
</p>

<p>and <code class="reqn">(x - a)_+ = max(0, x - a)</code>.
</p>


<h3>Value</h3>

<p>A list of class <code>"flexsurvreg"</code> with the same elements as
described in <code>flexsurvreg</code>, and including extra components
describing the spline model.  See in particular:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>k</code></td>
<td>
<p>Number of knots.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>knots</code></td>
<td>
<p>Location of knots on the log time
axis.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>scale</code></td>
<td>
<p>The <code>scale</code> of the model, hazard, odds or normal.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>res</code></td>
<td>
<p>Matrix of maximum likelihood estimates and confidence limits.
Spline coefficients are labelled <code>"gamma..."</code>, and covariate effects
are labelled with the names of the covariates.
</p>
<p>Coefficients <code>gamma1,gamma2,...</code> here are the equivalent of
<code>s0,s1,...</code> in Stata <code>streg</code>, and <code>gamma0</code> is the equivalent
of the <code>xb</code> constant term.  To reproduce results, use the
<code>noorthog</code> option in Stata, since no orthogonalisation is performed on
the spline basis here.
</p>
<p>In the Weibull model, for example, <code>gamma0,gamma1</code> are
<code>-shape*log(scale), shape</code> respectively in <code>dweibull</code> or
<code>flexsurvreg</code> notation, or (<code>-Intercept/scale</code>,
<code>1/scale</code>) in <code>survreg</code> notation.
</p>
<p>In the log-logistic model with shape <code>a</code> and scale <code>b</code> (as in
<code>eha::dllogis</code> from the <span class="pkg">eha</span> package), <code>1/b^a</code> is
equivalent to <code>exp(gamma0)</code>, and <code>a</code> is equivalent to
<code>gamma1</code>.
</p>
<p>In the log-normal model with log-scale mean <code>mu</code> and standard
deviation <code>sigma</code>, <code>-mu/sigma</code> is equivalent to <code>gamma0</code> and
<code>1/sigma</code> is equivalent to <code>gamma1</code>.  </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loglik</code></td>
<td>
<p>The
maximised log-likelihood.  This will differ from Stata, where the sum of
the log uncensored survival times is added to the log-likelihood in
survival models, to remove dependency on the time scale.</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Christopher Jackson &lt;chris.jackson@mrc-bsu.cam.ac.uk&gt;
</p>


<h3>References</h3>

<p>Royston, P. and Parmar, M. (2002).  Flexible parametric
proportional-hazards and proportional-odds models for censored survival
data, with application to prognostic modelling and estimation of treatment
effects. Statistics in Medicine 21(1):2175-2197.
</p>
<p>Wang W, Yan J (2021). Shape-Restricted Regression Splines with R
Package splines2. Journal of Data Science, 19(3), 498-517.
</p>
<p>Jackson, C. (2016). flexsurv: A Platform for Parametric Survival Modeling
in R. Journal of Statistical Software, 70(8), 1-33.
doi:10.18637/jss.v070.i08
</p>


<h3>See Also</h3>

<p><code>flexsurvreg</code> for flexible survival modelling using
general parametric distributions.
</p>
<p><code>plot.flexsurvreg</code> and <code>lines.flexsurvreg</code> to plot
fitted survival, hazards and cumulative hazards from models fitted by
<code>flexsurvspline</code> and <code>flexsurvreg</code>.
</p>


<h3>Examples</h3>

<pre><code class="language-R">
## Best-fitting model to breast cancer data from Royston and Parmar (2002)
## One internal knot (2 df) and cumulative odds scale

spl &lt;- flexsurvspline(Surv(recyrs, censrec) ~ group, data=bc, k=1, scale="odds")

## Fitted survival

plot(spl, lwd=3, ci=FALSE)

## Simple Weibull model fits much less well

splw &lt;- flexsurvspline(Surv(recyrs, censrec) ~ group, data=bc, k=0, scale="hazard")
lines(splw, col="blue", ci=FALSE)

## Alternative way of fitting the Weibull

## Not run: 
splw2 &lt;- flexsurvreg(Surv(recyrs, censrec) ~ group, data=bc, dist="weibull")

## End(Not run)

</code></pre>


</div>